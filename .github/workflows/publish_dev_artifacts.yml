# =============
# This file is automatically generated from the templates in stackabletech/operator-templating
# DON'T MANUALLY EDIT THIS FILE
# =============
name: Publish Dev Artifacts

on:
  push:
    branches:
      - main
  pull_request:

env:
  PRODUCT_NAME: zookeeper
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: '0'
  CARGO_PROFILE_DEV_DEBUG: '0'
  RUSTFLAGS: "-D warnings -W rust-2021-compatibility"
  REPO_HELM_DEV_URL: https://repo.stackable.tech/repository/helm-dev
  CHART_TESTING_CONFIG: deploy/helm/chart-testing.yaml

jobs:
  helm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.STACKY_MC_STACKFACE_TOKEN }}
          fetch-depth: 0
      - name: Set up Helm
        uses: azure/setup-helm@v1
        with:
          version: v3.6.2
      - name: Compile chart
        run: make compile-chart
      - name: Package Chart
        run: mkdir -p target/helm && helm package --destination target/helm deploy/helm/${{ env.PRODUCT_NAME }}-operator
      - name: Publish Chart
        env:
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        if: env.NEXUS_PASSWORD != null
        run: >-
          /usr/bin/curl
          --fail
          -u 'github:${{ secrets.NEXUS_PASSWORD }}'
          --upload-file "./$(find  target/helm/ -name *.tgz)"
          "${{ env.REPO_HELM_DEV_URL }}/"
      - name: Clean old manifests
        run: mkdir -p deploy/manifests && rm -r $(find deploy/manifests -maxdepth 1 -mindepth 1 -not -name kustomization.yaml)
      - name: Generate Manifests
        run: mkdir -p target/manifests && helm template --output-dir target/manifests --include-crds "./$(find  target/helm/ -name *.tgz)"
      - name: Cleanup Helm Labels
        run: |
         find target/manifests -type f |xargs -L 1 yq eval -i 'del(.. | select(has("app.kubernetes.io/managed-by")) | ."app.kubernetes.io/managed-by")'
         find target/manifests -type f |xargs -L 1 yq eval -i 'del(.. | select(has("helm.sh/chart")) | ."helm.sh/chart")'
      - name: Copy manifests to repo
        run: cp -r target/manifests/${{ env.PRODUCT_NAME }}-operator/*/* deploy/manifests/
      - name: Add & Commit
        uses: EndBug/add-and-commit@v7
        with:
          default_author: user_info
          author_name: Stacky McStackface
          author_email: stackable-bot@users.noreply.github.com
          pathspec_error_handling: exitImmediately
          pull: NO-PULL
          add: 'deploy'
          message: 'Github Actions: Generated k8s manifest files'



