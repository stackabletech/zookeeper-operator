---
apiVersion: v1
kind: Pod
metadata:
  name: "zookeeper-operator-create-cluster-test"
  labels:
    app.kubernetes.io/name: zookeeper-operator
    app.kubernetes.io/instance: zookeeper-operator
    app.kubernetes.io/version: "0.8.0-nightly"
    helm.sh/test: zookeeper-operator-0.8.0-nightly
  annotations:
    "helm.sh/hook": test
    "test": "zookeeper cluster should exist"
spec:
  containers:
    - name: kubectl
      image: bitnami/kubectl:latest
      command:
        - bash
        - "-c"
        - |
          kubectl apply -f - <<EOF
          apiVersion: zookeeper.stackable.tech/v1alpha1
          kind: ZookeeperCluster
          metadata:
            name: "zookeeper-operator-test-cluster"
            labels:
              helm.sh/test: zookeeper-operator-0.8.0-nightly
          spec:
            version: 3.5.8
            servers:
              roleGroups:
                default:
                  selector:
                    matchLabels:
                      kubernetes.io/arch: stackable-linux
                  replicas: 1
                  config:
                    metricsPort: 9505
          EOF
          kubectl describe ZookeeperCluster "zookeeper-operator-test-cluster"
          until [[ $(kubectl get pods -l app.kubernetes.io/instance=zookeeper-operator-test-cluster -o name | wc -l) == "1" ]];
          do
            sleep 10
          done
          kubectl delete ZookeeperCluster "zookeeper-operator-test-cluster"
          until [[ $(kubectl get pods -l app.kubernetes.io/instance=zookeeper-operator-test-cluster -o name | wc -l) == "0" ]];
          do
            sleep 10
          done
  restartPolicy: Never
  serviceAccountName: "zookeeper-operator-test-service-account"
